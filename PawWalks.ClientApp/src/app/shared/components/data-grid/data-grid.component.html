<div [class]="_config().containerClass || 'data-grid-container'" class="w-full">
  <!-- Filter -->
  @if (_config().filterable) {
    <mat-form-field class="w-full mb-4">
      <mat-label>{{ _config().filterPlaceholder }}</mat-label>
      <input matInput (keyup)="applyFilter($event)" />
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>
  }

  <!-- Loading spinner -->
  @if (_config().loading) {
    <div class="flex justify-center items-center p-8">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  }

  <!-- Table -->
  @if (!_config().loading) {
    <div class="mat-elevation-z2 overflow-auto">
      <table
        mat-table
        [dataSource]="dataSource"
        matSort
        class="w-full"
        [class.cursor-pointer]="rowClick.observed"
        multiTemplateDataRows
      >
        <!-- Expand Column -->
        @if (_config().expandable) {
          <ng-container matColumnDef="expand">
            <th mat-header-cell *matHeaderCellDef class="w-12"></th>
            <td mat-cell *matCellDef="let row" class="w-12">
              <button
                mat-icon-button
                (click)="toggleRowExpansion(row, $event)"
                [attr.aria-label]="'Expand row'"
              >
                <mat-icon>
                  {{ isRowExpanded(row) ? "expand_less" : "expand_more" }}
                </mat-icon>
              </button>
            </td>
          </ng-container>
        }
        <!-- Selection Column -->
        @if (_config().selectable) {
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef class="w-12">
              <mat-checkbox
                (change)="$event ? toggleAllRows() : null"
                [checked]="selection.hasValue() && isAllSelected()"
                [indeterminate]="selection.hasValue() && !isAllSelected()"
                [aria-label]="checkboxLabel()"
              >
              </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let row" class="w-12">
              <mat-checkbox
                (click)="$event.stopPropagation()"
                (change)="$event ? toggleRow(row) : null"
                [checked]="selection.isSelected(row)"
                [aria-label]="checkboxLabel(row)"
              >
              </mat-checkbox>
            </td>
          </ng-container>
        }

        <!-- Dynamic Columns -->
        @for (column of _config().columns; track column.key) {
          <ng-container [matColumnDef]="column.key">
            <th
              mat-header-cell
              *matHeaderCellDef
              [mat-sort-header]="column.sortable ? column.key : ''"
              [disabled]="!column.sortable"
              [style.width]="column.width"
              [class]="column.cssClass"
              [style.text-align]="column.align || 'left'"
            >
              {{ column.header }}
            </th>
            <td
              mat-cell
              *matCellDef="let row"
              [class]="column.cssClass"
              [style.text-align]="column.align || 'left'"
            >
              @if (column.cellTemplate) {
                <ng-container
                  *ngTemplateOutlet="
                    column.cellTemplate;
                    context: { $implicit: row }
                  "
                ></ng-container>
              } @else if (column.renderAsHtml) {
                <span [innerHTML]="getCellValue(row, column)"></span>
              } @else {
                {{ getCellValue(row, column) }}
              }
            </td>
          </ng-container>
        }

        <!-- Actions Column -->
        @if (
          _config().actions &&
          _config().actions &&
          _config().actions!.length > 0
        ) {
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="w-32">Actions</th>
            <td mat-cell *matCellDef="let row" class="w-32">
              <div class="flex gap-1">
                @for (action of _config().actions; track action.id) {
                  @if (isActionVisible(action, row)) {
                    <button
                      mat-icon-button
                      [color]="action.color"
                      [disabled]="isActionDisabled(action, row)"
                      [matTooltip]="action.label"
                      (click)="executeAction(action, row, $event)"
                    >
                      <mat-icon>{{ action.icon }}</mat-icon>
                    </button>
                  }
                }
              </div>
            </td>
          </ng-container>
        }

        <!-- Expanded Row Content -->
        @if (_config().expandable) {
          <ng-container matColumnDef="expandedDetail">
            <td
              mat-cell
              *matCellDef="let row"
              [attr.colspan]="displayedColumns().length"
              class="p-0"
            >
              <div
                class="expandable-row-content"
                [class.expanded]="isRowExpanded(row)"
              >
                @if (isRowExpanded(row) && expandedRowTemplate) {
                  <div class="p-4 bg-gray-50 border-t border-gray-200">
                    <ng-container
                      *ngTemplateOutlet="
                        expandedRowTemplate;
                        context: { $implicit: row }
                      "
                    ></ng-container>
                  </div>
                }
              </div>
            </td>
          </ng-container>
        }

        <!-- Header and Row Declarations -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns()"
          (click)="onRowClick(row)"
          [class.hover:bg-gray-50]="rowClick.observed"
        ></tr>
        @if (_config().expandable) {
          <tr
            mat-row
            *matRowDef="let row; columns: ['expandedDetail']"
            class="detail-row"
          ></tr>
        }

        <!-- No Data Row -->
        <tr class="mat-row" *matNoDataRow>
          <td
            class="mat-cell text-center py-8 text-gray-500"
            [attr.colspan]="displayedColumns().length"
          >
            {{ _config().noDataMessage }}
          </td>
        </tr>
      </table>
    </div>

    <!-- Paginator -->
    @if (_config().pageable) {
      <mat-paginator
        [pageSizeOptions]="_config().pageSizeOptions || [5, 10, 25, 50]"
        [pageSize]="_config().pageSize || 10"
        showFirstLastButtons
      >
      </mat-paginator>
    }
  }
</div>
